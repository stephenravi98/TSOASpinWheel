<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Team Selection - Participant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* (Keep all your existing CSS styles) */
    </style>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body>
    <!-- (Keep all your existing HTML structure) -->

    <script>
         // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries
  // Your web app's Firebase configuration
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        // Firebase Configuration - YOU MUST REPLACE WITH YOUR OWN
         const firebaseConfig = {
    apiKey: "AIzaSyDRKFLiU0ZJYy0ywoPWS0eSE6JSGy3aaLo",
    authDomain: "adrenalintsoateamselectionapp.firebaseapp.com",
    databaseURL: "https://adrenalintsoateamselectionapp-default-rtdb.firebaseio.com",
    projectId: "adrenalintsoateamselectionapp",
    storageBucket: "adrenalintsoateamselectionapp.firebasestorage.app",
    messagingSenderId: "1058584687065",
    appId: "1:1058584687065:web:7e9d8d3e209dbdee9fe9c8",
    measurementId: "G-084Q4KL0WB"
  };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Configuration
        const colors = [
            { name: "Red", value: "#e74c3c" },
            { name: "Blue", value: "#3498db" },
            { name: "Green", value: "#2ecc71" },
            { name: "Yellow", value: "#f1c40f" },
            { name: "Purple", value: "#9b59b6" }
        ];
        
        const totalParticipants = 450;
        const participantsPerColor = totalParticipants / colors.length;
        
        // Generate a device fingerprint
        function generateDeviceFingerprint() {
            const fingerprintData = [
                navigator.userAgent,
                navigator.hardwareConcurrency,
                navigator.deviceMemory,
                screen.width,
                screen.height,
                screen.colorDepth,
                new Date().getTimezoneOffset(),
                !!navigator.cookieEnabled,
                !!navigator.javaEnabled()
            ].join('|');
            
            // Simple hash function
            let hash = 0;
            for (let i = 0; i < fingerprintData.length; i++) {
                const char = fingerprintData.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0; // Convert to 32bit integer
            }
            return 'device-' + Math.abs(hash).toString(16);
        }
        
        // Check URL for special token
        function checkForSpecialToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            const employeeId = urlParams.get('employeeId');
            
            if (token && employeeId) {
                const glitchTokens = JSON.parse(localStorage.getItem('glitchTokens') || '{}');
                const tokenData = glitchTokens[token];
                
                if (tokenData && tokenData.employeeId === employeeId) {
                    // Token is valid - allow spin for this employee
                    const assignments = JSON.parse(localStorage.getItem('teamAssignments') || '{}');
                    delete assignments[employeeId];
                    localStorage.setItem('teamAssignments', JSON.stringify(assignments));
                    
                    // Remove device lock for this employee
                    const deviceAssignments = JSON.parse(localStorage.getItem('deviceAssignments') || '{}');
                    const deviceFingerprint = generateDeviceFingerprint();
                    delete deviceAssignments[deviceFingerprint];
                    localStorage.setItem('deviceAssignments', JSON.stringify(deviceAssignments));
                    
                    // Remove token from localStorage
                    delete glitchTokens[token];
                    localStorage.setItem('glitchTokens', JSON.stringify(glitchTokens));
                    
                    // Remove token from URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    // Enable spinning for this employee
                    const employeeIdInput = document.getElementById('employeeId');
                    employeeIdInput.value = employeeId;
                    employeeIdInput.disabled = false;
                    
                    document.getElementById('spinButton').disabled = false;
                    document.getElementById('alreadyCompleted').style.display = 'none';
                    document.getElementById('deviceLockedMessage').style.display = 'none';
                    
                    alert("Special access granted! You can now spin the wheel again.");
                } else {
                    alert("Invalid special access token");
                }
            }
        }
        
        // Save assignment to Firebase
        function saveAssignment(employeeId, color) {
            // Save to Firebase
            database.ref('assignments/' + employeeId).set({
                team: color.name,
                timestamp: new Date().getTime()
            });
            
            // Save to localStorage for device locking
            const deviceFingerprint = generateDeviceFingerprint();
            const deviceAssignments = JSON.parse(localStorage.getItem('deviceAssignments')) || {};
            deviceAssignments[deviceFingerprint] = employeeId;
            localStorage.setItem('deviceAssignments', JSON.stringify(deviceAssignments));
            
            // Save to local assignments
            const assignments = JSON.parse(localStorage.getItem('teamAssignments')) || {};
            assignments[employeeId] = color.name;
            localStorage.setItem('teamAssignments', JSON.stringify(assignments));
        }
        
        // Check if participant has already spun
        function checkParticipant(employeeId) {
            const assignments = JSON.parse(localStorage.getItem('teamAssignments') || '{}');
            return assignments[employeeId];
        }
        
        // Check if device is locked to an employee ID
        function checkDeviceLock() {
            const deviceFingerprint = generateDeviceFingerprint();
            const deviceAssignments = JSON.parse(localStorage.getItem('deviceAssignments')) || {};
            return deviceAssignments[deviceFingerprint];
        }
        
        // Show already completed message
        function showCompletedMessage(employeeId, color) {
            const employeeIdInput = document.getElementById('employeeId');
            const spinButton = document.getElementById('spinButton');
            const resultDiv = document.getElementById('result');
            const completedMessage = document.getElementById('alreadyCompleted');
            const completedId = document.getElementById('completedId');
            
            employeeIdInput.disabled = true;
            spinButton.disabled = true;
            resultDiv.style.display = 'none';
            
            completedId.textContent = employeeId;
            completedMessage.style.display = 'block';
            
            // Show their assigned color
            resultDiv.innerHTML = `<div class="color-indicator">
                <span class="color-box" style="background:${color.value}"></span>
                <span>Your team is: <strong>${color.name}</strong></span>
            </div>`;
            resultDiv.style.display = 'flex';
        }
        
        // Show device locked message
        function showDeviceLockedMessage() {
            const spinButton = document.getElementById('spinButton');
            const deviceLockedMessage = document.getElementById('deviceLockedMessage');
            
            spinButton.disabled = true;
            deviceLockedMessage.style.display = 'block';
        }
        
        // Simulate spinning animation
        function spinWheel() {
            const wheel = document.getElementById('wheel');
            const spinButton = document.getElementById('spinButton');
            const employeeIdInput = document.getElementById('employeeId');
            const employeeId = employeeIdInput.value.trim();
            const resultDiv = document.getElementById('result');
            
            if (!employeeId) {
                alert("Please enter your Employee ID");
                return;
            }
            
            // Check if already completed
            const existingAssignment = checkParticipant(employeeId);
            if (existingAssignment) {
                const color = colors.find(c => c.name === existingAssignment);
                showCompletedMessage(employeeId, color);
                return;
            }
            
            // Check if device is locked to a different employee
            const deviceLockedEmployee = checkDeviceLock();
            if (deviceLockedEmployee && deviceLockedEmployee !== employeeId) {
                showDeviceLockedMessage();
                return;
            }
            
            // Disable button during spin
            spinButton.disabled = true;
            resultDiv.textContent = "Spinning...";
            
            // Generate random rotation (5 full rotations + random segment)
            const fullRotations = 5;
            const segmentAngle = 360 / colors.length;
            const randomSegment = Math.floor(Math.random() * colors.length);
            const rotation = (fullRotations * 360) + (randomSegment * segmentAngle) + (segmentAngle / 2);
            
            // Apply rotation
            wheel.style.transform = `rotate(${rotation}deg)`;
            
            // Calculate the actual segment at the pointer
            const normalizedRotation = rotation % 360;
            const segmentIndex = Math.floor(normalizedRotation / segmentAngle) % colors.length;
            const color = colors[segmentIndex];
            
            // Simulate server request delay
            setTimeout(() => {
                // Save assignment
                saveAssignment(employeeId, color);
                
                // Update UI
                resultDiv.innerHTML = `<div class="color-indicator">
                    <span class="color-box" style="background:${color.value}"></span>
                    <span>Your team is: <strong>${color.name}</strong></span>
                </div>`;
                
                // Disable further spins
                employeeIdInput.disabled = true;
                
                // Show success message
                setTimeout(() => {
                    alert(`Assignment complete! You are on the ${color.name} team.`);
                }, 500);
            }, 5000);
        }
        
        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            checkForSpecialToken();
            
            // Check if device is locked to an employee
            const deviceLockedEmployee = checkDeviceLock();
            if (deviceLockedEmployee) {
                const employeeIdInput = document.getElementById('employeeId');
                employeeIdInput.value = deviceLockedEmployee;
                employeeIdInput.disabled = true;
                
                const existingAssignment = checkParticipant(deviceLockedEmployee);
                if (existingAssignment) {
                    const color = colors.find(c => c.name === existingAssignment);
                    showCompletedMessage(deviceLockedEmployee, color);
                } else {
                    showDeviceLockedMessage();
                }
            }
            
            // Set up event listeners
            document.getElementById('spinButton').addEventListener('click', spinWheel);
            
            // Check for existing assignment on page load
            const urlParams = new URLSearchParams(window.location.search);
            const employeeIdFromUrl = urlParams.get('employeeId');
            
            if (employeeIdFromUrl) {
                const existingAssignment = checkParticipant(employeeIdFromUrl);
                if (existingAssignment) {
                    const color = colors.find(c => c.name === existingAssignment);
                    showCompletedMessage(employeeIdFromUrl, color);
                }
            }
            
            // Automatically check if user has already spun
            const storedEmployeeId = localStorage.getItem('lastEmployeeId');
            if (storedEmployeeId) {
                const existingAssignment = checkParticipant(storedEmployeeId);
                if (existingAssignment) {
                    const employeeIdInput = document.getElementById('employeeId');
                    employeeIdInput.value = storedEmployeeId;
                    const color = colors.find(c => c.name === existingAssignment);
                    showCompletedMessage(storedEmployeeId, color);
                }
            }
        });
    </script>
</body>
</html>